<!DOCTYPE html>
<html>
    <head>
        <style type="text/css">
            html, body { height: 100%; margin: 0; padding: 0; }
            #map { height: 100%;
                   width: 79%;
                   float: right;}
            #content-window {
                position: fixed;
                font-family: 'Helvetica';
                height: 100%;
                line-height: 30px;
                padding-left: 10px;
                width: 200px;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="content-window"></div>
        <script type="text/javascript">

            var map;
            var ctfastrak;
            var trips;
            var busArray = [];

            //Added*****************************
            var gmarkers = [];
            var userLat;
            var userLng;
            var isInRange;
            var polygonCoords;
            var fastrakPolygon;
            var busStops;
            var stopsParsed;
            //**********************************




            function initMap() {
                //Create map object
                map = new google.maps.Map(document.getElementById('map'),
                        {center: {lat: 41.72, lng: -72.74},
                            zoom: 12
                        });

                //Added****************************************************
                var centerControlDiv = document.createElement('div');
                var centerControl = new CenterControl(centerControlDiv, map);
                centerControlDiv.index = 1;
                map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);
                var shareControlDiv = document.createElement('div');
                var shareControl = new ShareControl(shareControlDiv, map);
                shareControlDiv.index = 1;
                map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(shareControlDiv);
                //*********************************************************

                //Load CTFastrak routes, parking, and multi-use trail access points
                ctfastrak = new google.maps.KmlLayer({map: map,
                    url: 'https://kvn-dly.github.io/CTfastrak%20-%20%20Rapid%20Transit%20Service.kmz',
                    preserveViewport: true,
                    suppressInfoWindows: true
                });

                //Display CTFastrak KML attributes in 'content-window' div
                ctfastrak.addListener('click', function (kmlEvent) {
                    var text = kmlEvent.featureData.name + '<br>' + kmlEvent.featureData.description;
                    showInContentWindow(text);
                });

                //Send html to 'content-window' div
                function showInContentWindow(text) {
                    var contentWindow = document.getElementById('content-window');
                    contentWindow.innerHTML = text;
                }
                ;

                //Set map layer style for bus stops
                map.data.setStyle(function (feature) {
                    return({icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: 'pink',
                            fillOpacity: .5,
                            strokeColor: 'white',
                            strokeWeight: .5,
                            scale: 3
                        }});
                });

                //Add bus stops	  
                var stops = map.data.loadGeoJson('https://kvn-dly.github.io/fastrakStops.json');





                map.data.addListener('click', function (event) {
                    text = "";
                    var i;

                    for (i = 0; i < Object.keys(trips["entity"]).length; i++) {
                        var j;
                        for (j = 0; j < Object.keys(trips["entity"][i].trip_update.stop_time_update).length; j++) {
                            if (trips["entity"][i].trip_update.stop_time_update[j].stop_id === event.feature.getProperty('stop_id')) {
                                var d = new Date(1970, 0, 1);
                                var t;
                                d.setSeconds(trips["entity"][i].trip_update.stop_time_update[j].arrival.time);
                                d.setHours(d.getHours() - 5);
                                t = d.toLocaleTimeString();
                                text = text + '<br>' + trips["entity"][i].trip_update.vehicle.label + " : " + t;
                            }
                        }
                    }
                    document.getElementById('content-window').innerHTML = "<span style='background-color:yellow'><b>" + event.feature.getProperty('stop_name') + "</b></span>" + text;
                });

                var ctfastrakBounds = new google.maps.Polygon({
                    paths: [
                        new google.maps.LatLng(41.845, -72.558),
                        new google.maps.LatLng(41.611, -72.965),
                        new google.maps.LatLng(41.611, -72.558),
                        new google.maps.LatLng(41.845, -72.965)
                    ]
                });

                //Added*****************************************

                polygonCoords = [
                    {lat: 41.806523, lng: -72.751854},
                    {lat: 41.806523, lng: -72.586373},
                    {lat: 41.726378, lng: -72.590493},
                    {lat: 41.616617, lng: -72.754944},
                    {lat: 41.645357, lng: -72.869614},
                    {lat: 41.750716, lng: -72.853821},
                    {lat: 41.806523, lng: -72.751854}
                ];

                fastrakPolygon = new google.maps.Polygon({
                    paths: polygonCoords,
                    strokeColor: 'red',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.8});

                busStops = {
                    "data": [
                        {
                            "stop_id": 7984,
                            "stop_name": "Fenn Rd and CTFastrak",
                            "longitude": -72.756902,
                            "latitude": 41.696115
                        },
                        {
                            "stop_id": 12283,
                            "stop_name": "CTFastrak and East Main St Station",
                            "longitude": -72.766231,
                            "latitude": 41.671482

                        },
                        {
                            "stop_id": 12284,
                            "stop_name": "CTFastrak and East St Station",
                            "longitude": -72.758581,
                            "latitude": 41.687564
                        },
                        {
                            "stop_id": 12285,
                            "stop_name": "CTFastrak and Cedar St Station",
                            "longitude": -72.753671,
                            "latitude": 41.695952
                        },
                        {
                            "stop_id": 12286,
                            "stop_name": "CTFastrak and Newington Junction Station",
                            "longitude": -72.736253,
                            "latitude": 41.716183
                        }
                    ]
                };


                //*********************************************


                google.maps.event.addListener(map, 'click', function (event) {
                    console.log(google.maps.geometry.poly.containsLocation(event.latLng, ctfastrakBounds));
                });

                getTrips();
                getBusLocations();
                displayWalkRoute(41.8, -72.766231, 41.9, -72.736253);
                displayWalkRoute(42, -72, 41.5, -72.236253);

            }

            function getTrips() {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "http://65.213.12.244/realtimefeed/tripupdate/tripupdates.json", true);
                xhr.onload = function () {
                    trips = eval("(" + xhr.response + ")");

                };
                xhr.send();
            }

            function getBusLocations() {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "http://65.213.12.244/realtimefeed/vehicle/vehiclepositions.json", true);
                xhr.onload = function () {
                    var feed = eval("(" + xhr.response + ")");
                    var coords = "";
                    var i;
                    for (var i = 0; i < busArray.length; i++) {
                        busArray[i].setMap(null);
                    }
                    busArray = [];
                    for (i = 0; i < Object.keys(feed["entity"]).length; i++) {
                        var marker = new google.maps.Marker({
                            position: {lat: feed["entity"][i].vehicle.position.latitude, lng: feed["entity"][i].vehicle.position.longitude},
                            map: map,
                            title: feed["entity"][i].id,
                            icon: 'vehicle12.png'});
                        busArray.push(marker);
                    }

                };
                xhr.send();
            }

            //Reload realtime data every 30 seconds
            setInterval(function () {
                getBusLocations();
            }, 30000);
            setInterval(function () {
                getTrips();
            }, 30000);

            //Added************************************************

            function ShareControl(controlDiv, map) {
                // Set CSS for the control border.
                var controlUI = document.createElement('div');
                controlUI.style.backgroundColor = '#fff';
                controlUI.style.border = '2px solid #fff';
                controlUI.style.borderRadius = '3px';
                controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                controlUI.style.cursor = 'pointer';
                controlUI.style.marginBottom = '5dp';
                controlUI.style.textAlign = 'center';
                controlUI.title = 'Share your current location';
                controlDiv.appendChild(controlUI);
                // Set CSS for the control interior.
                var controlText = document.createElement('div');
                controlText.style.color = 'rgb(25,25,25)';
                controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                controlText.style.fontSize = 'Small';
                controlText.style.lineHeight = '20dp';
                controlText.style.paddingLeft = '3dp';
                controlText.style.paddingRight = '3dp';
                controlText.innerHTML = 'Share Location';
                controlUI.appendChild(controlText);
                // Setup the click event listeners: simply set the map to Chicago.
                controlUI.addEventListener('click', shareLocation);

            }

            function shareLocation() {

                var startPos;
                var geoOptions = {
                    enableHighAccuracy: true,
                    timeout: 10 * 1000
                }

                var geoSuccess = function (position) {
                    startPos = position;
                    document.getElementById('startLat').innerHTML = startPos.coords.latitude;
                    document.getElementById('startLon').innerHTML = startPos.coords.longitude;
                    var testPoint = LatLng(startPos.coords.latitude, startPos.coords.logitude, false);
                    isInRange = map.geometry.poly.containsLocation(testPoint, fastrakPolygon) ? true : false;
                    var userLat = startPos.coords.latitude;
                    var userLng = startPos.coords.latitude;
                    console.log('Get position succeeded');
                    console.log(userLat);
                    console.log(userLng);
                    return userLat, userLng, isInRange;
                };
                var geoError = function (error) {
                    console.log('Error occurred. Error code: ' + error.code);
                    // error.code can be:
                    //   0: unknown error
                    //   1: permission denied
                    //   2: position unavailable (error response from location provider)
                    //   3: timed out
                };

                navigator.geolocation.getCurrentPosition(geoSuccess, geoError, geoOptions);

            }

            function CenterControl(controlDiv, map) {
                // Set CSS for the control border.
                var controlUI = document.createElement('div');
                controlUI.style.backgroundColor = '#fff';
                controlUI.style.border = '2px solid #fff';
                controlUI.style.borderRadius = '3px';
                controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                controlUI.style.cursor = 'pointer';
                controlUI.style.marginBottom = '5dp';
                controlUI.style.textAlign = 'center';
                controlUI.title = 'Click your location on the map';
                controlDiv.appendChild(controlUI);
                // Set CSS for the control interior.
                var controlText = document.createElement('div');
                controlText.style.color = 'rgb(25,25,25)';
                controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                controlText.style.fontSize = 'Small';
                controlText.style.lineHeight = '20dp';
                controlText.style.paddingLeft = '3dp';
                controlText.style.paddingRight = '3dp';
                controlText.innerHTML = 'Pick Location';
                controlUI.appendChild(controlText);
                // Setup the click event listeners: simply set the map to Chicago.
                controlUI.addEventListener('click', pickLocation);

            }

            function pickLocation() {
                google.maps.event.addListenerOnce(map, 'click', function (e) {
                    var resultColor =
                            google.maps.geometry.poly.containsLocation(e.latLng, fastrakPolygon) ?
                            'green' :
                            'red';
                    isInRange = google.maps.geometry.poly.containsLocation(e.latLng, fastrakPolygon)
                            ? true : false;
                    userLat = e.latLng.lat().toString();
                    userLng = e.latLng.lng().toString();

                    new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: resultColor,
                            fillOpacity: .2,
                            strokeColor: 'white',
                            strokeWeight: .5,
                            scale: 10
                        }
                    });

                    console.log(isInRange);
                    console.log(userLat);
                    console.log(userLng);
                    return isInRange, userLat, userLng;
                });
            }

//            function removeMarkers() {
//                for (i = 0; i < gmarkers.length; i++) {
//                    gmarkers[i].setMap(null);
//                }
//            }

            function distance(lat1, lon1, lat2, lon2, unit) {
                var radlat1 = Math.PI * lat1 / 180;
                var radlat2 = Math.PI * lat2 / 180;
                var radlon1 = Math.PI * lon1 / 180;
                var radlon2 = Math.PI * lon2 / 180;
                var theta = lon1 - lon2;
                var radtheta = Math.PI * theta / 180;
                var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
                dist = Math.acos(dist);
                dist = dist * 180 / Math.PI;
                dist = dist * 60 * 1.1515;
                if (unit === "K") {
                    dist = dist * 1.609344;
                }
                ;
                if (unit === "N") {
                    dist = dist * 0.8684;
                }
                ;
                return dist;
            }

            function displayWalkRoute(startLat, startLng, endLat, endLng) {

                var start = new google.maps.LatLng(startLat, startLng);
                var end = new google.maps.LatLng(endLat, endLng);

                var directionsDisplay = new google.maps.DirectionsRenderer();
                directionsDisplay.setMap(map); 

                var request = {
                    origin: start,
                    destination: end,
                    travelMode: google.maps.TravelMode.WALKING
                };
                var directionsService = new google.maps.DirectionsService();
                directionsService.route(request, function (response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(response);
                    }
                });
            }
            
            function displayBusRoute(startLat, startLng, endLat, endLng) {

                var start = new google.maps.LatLng(startLat, startLng);
                var end = new google.maps.LatLng(endLat, endLng);

                var directionsDisplay = new google.maps.DirectionsRenderer();
                directionsDisplay.setMap(map); 

                var request = {
                    origin: start,
                    destination: end,
                    travelMode: google.maps.TravelMode.TRANSIT
                };
                var directionsService = new google.maps.DirectionsService();
                directionsService.route(request, function (response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(response);
                    }
                });
            }
            
           
            function calcClosestStop(startLat, startLng) {
                var shortestDistance = 5000000;
                var currentDistance;
                for (i = 0; i < busStops.length; i++) {
                    var currentDistance = distance(busStops.data[i].latitude, busStops.data[i].longitude, startLat, startLng, "M");
                    if (currentDistance < shortestDistance) {
                        shortestDistance = currentDistance;
                        var lowestI = i;
                    }
                    ;
                }
                return busStops.data[0].latitude;
            }

            //**************************************************


        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKCfeZWk7iA9OXoLSWVpUfXoLm2ekRvgg&callback=initMap">
        </script>
        <!--
                <div>Icons made by <a href="http://www.flaticon.com/authors/graphicsbay" title="GraphicsBay">GraphicsBay</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a>             is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>
                <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a>             is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>
        -->
    </body>
</html>